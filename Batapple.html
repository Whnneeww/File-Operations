<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>動画フレームをTXTに変換</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.6.0/jszip.min.js"></script>
</head>
<body>
    <h1>動画フレームをTXTに変換してZIP化</h1>
    <input type="file" id="videoFile" accept="video/*">
    <button id="processButton">処理開始</button>

    <script>
        document.getElementById('processButton').addEventListener('click', async () => {
            const videoFile = document.getElementById('videoFile').files[0];
            if (!videoFile) {
                alert("ビデオファイルをアップロードしてください！");
                return;
            }

            const video = document.createElement('video');
            const zip = new JSZip();
            let frameCount = 0;

            video.src = URL.createObjectURL(videoFile);
            video.addEventListener('loadeddata', async () => {
                if (video.readyState >= 2) {
                    const canvas = document.createElement('canvas');
                    const context = canvas.getContext('2d');
                    canvas.width = video.videoWidth; // 動画の幅に合わせる
                    canvas.height = video.videoHeight; // 動画の高さに合わせる

                    // 動画のフレームを1つずつ処理する
                    while (video.currentTime < video.duration) {
                        context.drawImage(video, 0, 0, canvas.width, canvas.height);
                        const frameData = context.getImageData(0, 0, canvas.width, canvas.height).data;
                        let txtData = '';

                        // 画素データを白黒に変換
                        for (let i = 0; i < frameData.length; i += 4) {
                            const avgColor = (frameData[i] + frameData[i + 1] + frameData[i + 2]) / 3;
                            txtData += avgColor < 128 ? '1' : '0'; // 黒なら1、白なら0
                        }

                        // ファイル名を設定
                        const fileName = `frame_${String(frameCount).padStart(4, '0')}.txt`;
                        zip.file(fileName, txtData);
                        frameCount++;

                        // 1フレームごとに進める（30fpsを仮定）
                        await new Promise(resolve => video.currentTime += (1 / 30)); 
                    }

                    // ZIPファイルの生成
                    const zipContent = await zip.generateAsync({ type: "blob" });
                    const link = document.createElement('a');
                    link.href = URL.createObjectURL(zipContent);
                    link.download = 'frames.zip';
                    link.click();
                }
            });

            video.load();
        });
    </script>
</body>
</html>
